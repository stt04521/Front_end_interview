- VDOM 是什么？为什么会存在 VDOM？
- VDOM 如何应用，核心 API 是什么
- 介绍 diff 算法

### VDOM 是什么？为什么会存在 VDOM？

dom  将一个HTML文档抽象表达为树结构，VDOM 将dom结构，抽象生成js对象，这个对象也拥有DOM上的一些属性，比如id, class等
```
createElement(type, props, children)
```
在 MVVM 开发方式中，页面的变化都是用数据去驱动的，而数据更新后，到底要去改那一块的 DOM 哪？ 虽然可以先删除那个部分再按照当前新的数据去重新生成一个新的页面或生成那一个部分（jQuery 做法），但是这样肯定非常耗费性能的。 而且 JS 操作 DOM 是非常复杂，JS 操作 DOM 越多，控制与页面的耦合度就越高，代码越难以维护。

虚拟 DOM，即用 JS 对象来描述 DOM 树结构，Diff 算法则是找旧 VDOM 与新的 VDOM 的最小差异，然后再把差异渲染出来

### VDOM 如何运用
- 创建虚拟节点
    - h('标签名', {...属性...}, [...子元素...])
    - h('标签名', {...属性...}, '文本内容')
- 将 VNode 添加到一个 DOM 元素内
    - patch(DOM_obj, vnode);
- 用一个新的 vnode 来和旧的 vnode 进行比较，得出新旧 dom 的差异
    - patch(vnode, newVnode)

### diff算法

策略
- Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。（tree diff）

- 拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结（component diff）
- 对于同一层级的一组子节点，它们可以通过唯一 id 进行区分。（element diff）

#### tree diff
- React通过updateDepth对Virtual DOM树进行层级控制，只会对层级相同的


- 节点比较，同层级比较，不会跨层级比较，如果发现不同，删除不同节点，从这个节点开始，重新向下渲染，不会比较子节点

- 只需遍历一次，就能完成整棵DOM树的比较。

#### Components diff 算法

- React 只会匹配相同 class 的 component.如果class不同 直接删除原有，创建一个新的组件

- 同一类型的两个组件，按原策略（层级比较）继续比较Virtual DOM树即可。

- 如果是同一个类型的组件，有可能经过一轮Virtual DOM比较下来，并没有发生变化。如果我们能够提前确切知道这一点，那么就可以省下大量的diff运算时间。因此，React允许用户通过shouldComponentUpdate()来判断该组件是否需要进行diff算法分析。

#### element diff

当节点处于同一层级时，diff提供三种节点操作：删除、插入、移动

- 新的组件类型不在旧集合中，即全新的节点，需要对新节点进行插入操作。
- 旧集合中有新组件类型，且element是可更新的类型，这时候就需要做移动操作，可以复用以前的DOM节点
- 旧组件类型，在新集合里也有，但对应的element不同则不能直接复用和更新，需要执行删除操作，或者旧组件不在新集合里的，也需要执行删除操作。


#### key 的作用

在列表循环的时候 React 会要求每一个列表项有一个独一无二，稳定的 key 值，它的目的是为了当状态改变时新旧状态的每一个列表项能够对应起来，方便比对。

Keys 是 React 用于追踪哪些列表中元素被修改、被添加或者被移除的辅助标识。 Diff 算法中 React 会借助元素的 Key 值来判断该元素是新近创建的还是被移动而来的元素，从而减少不必要的元素重渲染。此外，React 还需要借助 Key 值来判断元素与本地状态的关联关系


> 由于列表项目的顺序可能会变化，我们不建议使用索引来用作 key 值，因为这样做会导致性能变差，还可能引起组件状态的问题。

key 使用下标，带来的性能问题
https://juejin.cn/post/6844904133430870024

当数组map输出input(非受控组件)，在所有输入框输入值时，然后通过点击事件在数组头部加一个元素或颠倒数组元素，会发现input刚才所输入的值依然存在并没有进行更新。
因为会认为插入的组件生成新的DOM 树，控件对应的key与原有key保持一致，与原有组件为同一元素，并不会创建新组件，而是更新状态，原有的input值与状态无关，无法更新到


例如，当你向列表中添加一条数据或者移除某条数据时。如果该键与之前的相同，React会认为DOM元素表示的组件和以前是一样的。

- key相同：若组件属性有所变化，则react只更新组件对应的属性；没有变化则不更新。
- key值不同：则react先销毁该组件，然后重新创建该组件。